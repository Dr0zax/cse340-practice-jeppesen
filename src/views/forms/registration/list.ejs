<%- include('../../partials/header') %>
<h1><%= title %></h1>

<% // Make currentUser available outside the loop so we don't accidentally return from the template function %>
<% const currentUser = sessionData ? sessionData.user : null; %>

<% if (users && users.length > 0) { %>
  <div class="users-list">
    <% users.forEach((user) => { %>
      <div class="user-card">
        <h3><%= user.name %></h3>
        <p><%= user.email %></p>
        <div class="actions">
          <% if (currentUser) {
               const isOwnCard = currentUser.id === user.id;
               const isAdmin = currentUser.role_name === 'admin';
               const canEdit = isOwnCard || isAdmin;
               const canDelete = isAdmin && !isOwnCard;
               if (canEdit) { %>
                 <a href="/users/<%= user.id %>/edit">Edit</a>
          <%   }
               if (canDelete) { %>
                 <form
                   method="POST"
                   action="/users/<%= user.id %>/delete"
                   style="display: inline"
                 >
                   <button type="submit" onclick="return confirm('Delete this user?')">
                     Delete
                   </button>
                 </form>
          <%   }
             } %>
        </div>
      </div>
    <% }); %>
  </div>
<% } else { %>
  <p class="no-users">No registered users found.</p>
<% } %>

<form method="POST" action="#" id="testing-form">
    <p>
        Ensure you are logged-in as a <strong>standard (non-admin)</strong> user before submitting this form to test access restrictions.
    </p>
    <input type="text" name="port" placeholder="Port (default: 8080)" />
    <button type="submit">Send Post</button>
</form>
<script type="text/javascript">
    const form = document.querySelector('#testing-form');
    form.addEventListener('submit', (event) => {
        event.preventDefault();
        const portInput = form.querySelector('input[name="port"]');
        const port = portInput.value || '8080';
        form.action = `/users/2/delete`;
        form.submit();
    });
</script>

<%- include('../../partials/footer') %>
